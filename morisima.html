<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ã‚¨ãƒãƒ«ã‚®ãƒ¼è§£æãƒ„ãƒ¼ãƒ«</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #f39c12;
            --bg-color: #f4f7f6;
            --sidebar-width: 420px;
            --header-height: 60px;
            --ad-height: 64px; /* ãƒ†ã‚­ã‚¹ãƒˆåºƒå‘Šã®é«˜ã• */
        }

        body {
            margin: 0;
            font-family: 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: var(--bg-color);
            color: #333;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        header {
            height: var(--header-height);
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .logo { font-size: 1.2rem; font-weight: bold; letter-spacing: 1px; }
        .search-container { display: flex; gap: 10px; }
        #search-input { padding: 8px 12px; border-radius: 4px; border: none; width: 250px; }
        #search-btn { padding: 8px 15px; background: var(--accent-color); border: none; color: white; border-radius: 4px; cursor: pointer; font-weight: bold; }

        /* ãƒ¡ã‚¤ãƒ³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        #main { display: flex; flex: 1; overflow: hidden; }
        #map { flex: 1; z-index: 1; }

        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
        #sidebar {
            width: var(--sidebar-width);
            background: white;
            border-left: 1px solid #ddd;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            z-index: 2;
        }
        .tab-container { display: flex; background: #eee; }
        .tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; font-weight: bold; border-bottom: 3px solid transparent; }
        .tab.active { background: white; border-bottom-color: var(--accent-color); color: var(--accent-color); }
        .content-section { padding: 20px; display: none; }
        .content-section.active { display: block; }

        /* æ™‚é–“è»¸ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
        .time-controls {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #eee;
        }
        .control-group { margin-bottom: 15px; }
        .control-group label { display: block; font-size: 0.9rem; margin-bottom: 5px; font-weight: bold; }
        .season-buttons { display: flex; gap: 5px; }
        .season-btn { flex: 1; padding: 5px; border: 1px solid #ccc; background: white; cursor: pointer; border-radius: 4px; font-size: 0.8rem; }
        .season-btn.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }
        #time-slider { width: 100%; }

        /* è§£æçµæœã‚«ãƒ¼ãƒ‰ */
        .result-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .energy-type-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            color: white;
            font-size: 0.8rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .energy-title { font-size: 1.5rem; font-weight: 900; margin: 0 0 10px 0; }
        .location-info { font-size: 0.9rem; color: #666; margin-bottom: 15px; }

        /* ã‚°ãƒ©ãƒ•ã‚³ãƒ³ãƒ†ãƒŠ */
        .chart-container { margin-top: 20px; height: 250px; position: relative; }

        /* æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰ */
        .compare-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .compare-list { margin-bottom: 20px; }
        .btn-compare-exec {
            width: 100%;
            padding: 12px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
        }
        .remove-btn { color: #e74c3c; cursor: pointer; font-size: 1.2rem; }

        /* æ¯”è¼ƒãƒ¢ãƒ¼ãƒ€ãƒ« */
        #compare-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            width: 90%;
            max-width: 1000px;
            max-height: 90vh;
            border-radius: 12px;
            overflow-y: auto;
            padding: 30px;
            position: relative;
        }
        .close-modal { position: absolute; top: 20px; right: 20px; font-size: 2rem; cursor: pointer; }
        .compare-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .compare-table th, .compare-table td { padding: 12px; border: 1px solid #ddd; text-align: center; }
        .compare-table th { background: #f4f4f4; }
        .best-highlight { background: #fff9c4; font-weight: bold; border: 2px solid #fbc02d !important; }

        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
        #loading {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9);
            z-index: 4000;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #loading-text {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--primary-color);
            max-width: 80%;
            line-height: 1.5;
        }

        /* ===== ãƒ•ãƒƒã‚¿ãƒ¼åºƒå‘Šï¼ˆãƒ†ã‚­ã‚¹ãƒˆã®ã¿ï¼‰ ===== */
        #ad-footer {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 2500; /* ãƒãƒƒãƒ—ã‚ˆã‚Šä¸Šã€ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚ˆã‚Šä¸‹ */
            background: #ffffff;
            border-top: 1px solid rgba(0,0,0,0.1);
            box-shadow: 0 -4px 10px rgba(0,0,0,0.08);
            min-height: var(--ad-height);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px 56px 8px 12px; /* å³å´ã¯é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³åˆ† */
        }
        #ad-footer.hidden { display: none; }

        .ad-text-only {
            width: min(980px, 96vw);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .ad-link {
            display: inline-block;
            width: 100%;
            text-decoration: none;
            color: #1a237e;
            background: #f5f7ff;
            border: 1px solid #c5cae9;
            border-radius: 10px;
            padding: 12px 14px;
            font-weight: 700;
            letter-spacing: 0.2px;
        }
        .ad-link:hover { background: #eef2ff; }
        .ad-link:focus { outline: 3px solid #bbdefb; }

        .ad-close {
            position: absolute; right: 12px; top: 8px;
            width: 36px; height: 36px; border-radius: 18px;
            background: rgba(0,0,0,0.06); color:#333; border: none;
            font-size: 18px; cursor: pointer;
        }
        .ad-close:hover { background: rgba(0,0,0,0.1); }

        /* iOSã‚»ãƒ¼ãƒ•ã‚¨ãƒªã‚¢å¯¾å¿œ */
        @supports (padding: max(0px)) {
            #ad-footer { padding-bottom: max(8px, env(safe-area-inset-bottom)); }
        }

        /* åºƒå‘Šã¶ã‚“ã®ä¸‹ä½™ç™½ï¼ˆãƒ¡ã‚¤ãƒ³ãŒéš ã‚Œãªã„ã‚ˆã†ã«ï¼‰ */
        body.has-ad #main { margin-bottom: calc(var(--ad-height) + 8px); }
        body.has-ad #sidebar { padding-bottom: calc(var(--ad-height) + 24px); }
        body.modal-open #ad-footer { z-index: 2000; }
        #compare-modal[style*="display: flex"] ~ #ad-footer { z-index: 2000; }
    </style>
</head>
<body>

<header>
    <div class="logo">ã‚¨ãƒãƒ«ã‚®ãƒ¼è§£æãƒ„ãƒ¼ãƒ«</div>
    <div class="search-container">
        <input type="text" id="search-input" placeholder="å¸‚åŒºç”ºæ‘åã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šåˆ¥åºœå¸‚ã€ç¨šå†…å¸‚ï¼‰" />
        <button id="search-btn">è§£æå®Ÿè¡Œ</button>
    </div>
</header>

<div id="main">
    <div id="map"></div>
    <div id="sidebar">
        <div class="tab-container">
            <div class="tab active" onclick="switchTab('analyze')">åœ°ç‚¹è§£æ</div>
            <div class="tab" onclick="switchTab('compare')">æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰ (<span id="compare-count">0</span>)</div>
        </div>

        <!-- åœ°ç‚¹è§£æã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="analyze-section" class="content-section active">
            <div class="time-controls">
                <div class="control-group">
                    <label>è§£æå­£ç¯€</label>
                    <div class="season-buttons">
                        <button class="season-btn active" onclick="setSeason('spring')">æ˜¥</button>
                        <button class="season-btn" onclick="setSeason('summer')">å¤</button>
                        <button class="season-btn" onclick="setSeason('autumn')">ç§‹</button>
                        <button class="season-btn" onclick="setSeason('winter')">å†¬</button>
                    </div>
                </div>
                <div class="control-group">
                    <label>è§£ææ™‚é–“å¸¯: <span id="time-display">12:00</span></label>
                    <input type="range" id="time-slider" min="0" max="23" value="12" oninput="updateTime(this.value)" />
                </div>
            </div>

            <div id="result-placeholder" style="text-align:center; color:#999; margin-top:50px;">
                <h3>è§£æå¾…æ©Ÿä¸­</h3>
                <p>åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã‹æ¤œç´¢ã—ã¦ãã ã•ã„</p>
            </div>

            <div id="result-display" style="display:none;">
                <div class="result-card">
                    <div id="res-badge" class="energy-type-badge"></div>
                    <h2 id="res-title" class="energy-title"></h2>
                    <div id="res-location" class="location-info"></div>
                    <button id="add-compare-btn" style="width:100%; padding:8px; cursor:pointer; background:#eee; border:1px solid #ccc; border-radius:4px;">æ¯”è¼ƒãƒªã‚¹ãƒˆã«è¿½åŠ </button>
                </div>

                <h3>ç™ºé›»ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«åˆ†æ</h3>
                <div class="chart-container">
                    <canvas id="radarChart"></canvas>
                </div>

                <h3>24æ™‚é–“ç™ºé›»æ¨ç§»äºˆæ¸¬</h3>
                <div class="chart-container">
                    <canvas id="lineChart"></canvas>
                </div>

                <div id="res-description" style="margin-top:20px; line-height:1.6; font-size:0.9rem; border-top:1px solid #eee; padding-top:15px;"></div>
            </div>
        </div>

        <!-- æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="compare-section" class="content-section">
            <h3>æ¯”è¼ƒãƒªã‚¹ãƒˆ</h3>
            <div id="compare-list" class="compare-list"></div>
            <button class="btn-compare-exec" onclick="executeComparison()">ç·åˆæ¯”è¼ƒã‚’å®Ÿè¡Œ</button>
            <p style="font-size:0.8rem; color:#666; margin-top:10px;">â€»æœ€å¤§5ç®‡æ‰€ã¾ã§æ¯”è¼ƒå¯èƒ½ã§ã™ã€‚è¤‡æ•°ã®åœ°ç‚¹ã‚’è§£æã—ã¦ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>
        </div>
    </div>
</div>

<!-- æ¯”è¼ƒãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="compare-modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal()">&times;</span>
        <h2 style="text-align:center; border-bottom:2px solid var(--primary-color); padding-bottom:10px;">åœ°åŸŸã‚¨ãƒãƒ«ã‚®ãƒ¼ç·åˆæ¯”è¼ƒãƒ¬ãƒãƒ¼ãƒˆ</h2>
        <div id="compare-result-table"></div>
        <div id="compare-summary" style="margin-top:20px; padding:15px; background:#e8f5e9; border-radius:8px;"></div>
    </div>
</div>

<div id="loading">
    <div class="spinner"></div>
    <div id="loading-text"></div>
</div>

<!-- â–¼â–¼â–¼ ãƒ•ãƒƒã‚¿ãƒ¼åºƒå‘Šï¼ˆãƒ†ã‚­ã‚¹ãƒˆã®ã¿ï¼‰ â–¼â–¼â–¼ -->
<div id="ad-footer" class="hidden" role="region" aria-label="åºƒå‘Š">
    <button class="ad-close" id="ad-close" aria-label="åºƒå‘Šã‚’é–‰ã˜ã‚‹">Ã—</button>
    <div class="ad-text-only">
        <!-- ãƒ†ã‚­ã‚¹ãƒˆå…¨ä½“ãŒãƒªãƒ³ã‚¯ã¨ã—ã¦å‹•ä½œ -->
        <a id="ad-link" class="ad-link" href="#" target="_blank" rel="noopener">
            ã“ã®æ£®å³¶å„ªèª ã•ã‚“ã®ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã¯ã€6ã†ã‚åŸå„ªã®githubã§å…¬é–‹ä¸­ã§ã™ã€‚
        </a>
    </div>
</div>
<!-- â–²â–²â–² ãƒ•ãƒƒã‚¿ãƒ¼åºƒå‘Š â–²â–²â–² -->

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // --- å®šæ•°ã¨ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ ---
    const MASTER = {
        GEO_FLASH:   { n: "åœ°ç†±ï¼ˆå¤§å®¹é‡ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ï¼‰", c: "#c0392b", t: "ç«å±±å¸¯ã®å¼·åŠ›ãªè’¸æ°—ã‚’æ´»ç”¨ã™ã‚‹å®‰å®šé›»æºã€‚24æ™‚é–“å®‰å®šã—ãŸå‡ºåŠ›ãŒå¯èƒ½ã§ã™ã€‚", stable: 5, cost: 3, env: 5, future: 4 },
        GEO_BINARY:  { n: "æ¸©æ³‰å…±ç”Ÿå‹ãƒã‚¤ãƒŠãƒªãƒ¼åœ°ç†±", c: "#e67e22", t: "æ¸©æ³‰è³‡æºã‚’ä¿è­·ã—ã¤ã¤ç™ºé›»ã€‚è¦³å…‰ã¨ã‚¨ãƒãƒ«ã‚®ãƒ¼è‡ªçµ¦ã‚’ä¸¡ç«‹ã•ã›ã¾ã™ã€‚", stable: 5, cost: 2, env: 5, future: 4 },
        WIND_OFFSHORE:{ n: "æµ®ä½“å¼æ´‹ä¸Šé¢¨åŠ›ç™ºé›»", c: "#2980b9", t: "æµ·ä¸Šã®å¼·åŠ›ãªé¢¨ã‚’åŠ¹ç‡ã‚ˆãé›»æ°—ã«å¤‰ãˆã¾ã™ã€‚å°†æ¥ã®ä¸»åŠ›é›»æºã¨ã—ã¦æœŸå¾…ã•ã‚Œã¾ã™ã€‚", stable: 3, cost: 2, env: 4, future: 5 },
        WIND_ONSHORE:{ n: "é™¸ä¸Šé¢¨åŠ›ç™ºé›»", c: "#3498db", t: "ä¸˜é™µãƒ»å¹³åŸåœ°å¸¯ã§å±•é–‹ã€‚åœ°åŸŸã‚¨ãƒãƒ«ã‚®ãƒ¼ã®ä¸»è»¸ã‚’æ‹…ã†ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ãŒã‚ã‚Šã¾ã™ã€‚", stable: 3, cost: 4, env: 4, future: 3 },
        SOLAR_ROOF:  { n: "ãƒšãƒ­ãƒ–ã‚¹ã‚«ã‚¤ãƒˆå¤ªé™½å…‰", c: "#f1c40f", t: "ãƒ“ãƒ«å£é¢ã‚„çª“ã‚’æ´»ç”¨ã€‚éƒ½å¸‚éƒ¨ã§ã®ç™ºé›»ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ã‚’æœ€å¤§åŒ–ã—ã¾ã™ã€‚", stable: 2, cost: 3, env: 5, future: 5 },
        SOLAR_AGRI:  { n: "å–¶è¾²å‹å¤ªé™½å…‰", c: "#f39c12", t: "è¾²åœ°ã®ä¸Šç©ºã‚’æ´»ç”¨ã€‚è¾²æ¥­ã¨ç™ºé›»ã‚’ä¸¡ç«‹ã™ã‚‹åœ°åŸŸæ´»æ€§åŒ–ãƒ¢ãƒ‡ãƒ«ã§ã™ã€‚", stable: 2, cost: 4, env: 5, future: 4 },
        HYDRO_SMALL: { n: "ä¸­å°æ°´åŠ›ç™ºé›»", c: "#16a085", t: "æ²³å·ã®è‡ªç„¶ãªæµã‚Œã‚’æ´»ã‹ã—ã€24æ™‚é–“æ­¢ã¾ã‚‰ãªã„é›»åŠ›ã‚’ä¾›çµ¦ã—ã¾ã™ã€‚", stable: 5, cost: 3, env: 5, future: 3 },
        BIO_WOOD:    { n: "æ£®æ—æœ¨è³ªãƒã‚¤ã‚ªãƒã‚¹", c: "#27ae60", t: "é–“ä¼æã®åˆ©æ´»ç”¨ã«ã‚ˆã‚Šæ£®ã‚’å†ç”Ÿã—ã€ç†±ã¨é›»æ°—ã‚’å‰µå‡ºã—ã¾ã™ã€‚", stable: 5, cost: 3, env: 4, future: 3 },
        BIO_GAS:     { n: "å»ƒæ£„ç‰©ç³»ãƒã‚¤ã‚ªã‚¬ã‚¹", c: "#8e44ad", t: "éƒ½å¸‚ã®ç”Ÿã‚´ãƒŸã‚„æ±šæ³¥ã‚’æ´»ç”¨ã€‚è³‡æºå¾ªç’°å‹ç¤¾ä¼šã®è¦ã¨ãªã‚‹é›»æºã§ã™ã€‚", stable: 5, cost: 3, env: 5, future: 3 },
        SNOW:        { n: "é›ªæ°·ç†±ã‚¨ãƒãƒ«ã‚®ãƒ¼åˆ©ç”¨", c: "#a2deff", t: "å†¬ã®é›ªã‚’å¤ã®å†·æˆ¿ã‚¨ãƒãƒ«ã‚®ãƒ¼ã«å¤‰ãˆã‚‹ã€é›ªå›½ç‹¬è‡ªã®çŸ¥æµã§ã™ã€‚", stable: 4, cost: 3, env: 5, future: 2 },
        HYDROGEN:    { n: "ã‚°ãƒªãƒ¼ãƒ³æ°´ç´ è²¯è”µæ‹ ç‚¹", c: "#00cec9", t: "å†ã‚¨ãƒä½™å‰°åˆ†ã‚’æ°´ç´ ã¨ã—ã¦è²¯è”µã€‚å°†æ¥ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚¤ãƒ³ãƒ•ãƒ©ã®è¦ã§ã™ã€‚", stable: 4, cost: 1, env: 5, future: 5 },
        TIDAL:       { n: "æ½®æµãƒ»æ½®æ±ç™ºé›»", c: "#0984e3", t: "å¼·ã„æ½®æµã‚’åˆ©ç”¨ã€‚æœˆã®æº€ã¡æ¬ ã‘ã«åŸºã¥ã„ãŸç¢ºå®Ÿãªäºˆæ¸¬ãŒå¯èƒ½ã§ã™ã€‚", stable: 4, cost: 1, env: 4, future: 4 }
    };

    const SEASON_FACTORS = {
        spring: { solar: 0.9, wind: 0.8, hydro: 1.0, bio: 1.0, geo: 1.0 },
        summer: { solar: 1.0, wind: 0.4, hydro: 0.8, bio: 1.0, geo: 1.0 },
        autumn: { solar: 0.7, wind: 0.7, hydro: 0.6, bio: 1.0, geo: 1.0 },
        winter: { solar: 0.5, wind: 1.0, hydro: 0.4, bio: 1.0, geo: 1.0 }
    };

    const LOADING_MESSAGES = [
        "ã‚¨ãƒãƒ«ã‚®ãƒ¼ã®å¦–ç²¾ãŸã¡ãŒä¼šè­°ã‚’è¡Œã£ã¦ã„ã¾ã™...",
        "è†¨å¤§ãªãƒ‡ãƒ¼ã‚¿ã®ä¸­ã§ã€æ‹…å½“AIãŒè¿·å­ã«ãªã£ã¦ã„ã¾ã™ã€‚ä»Šã™ãæ•‘å‡ºï¼ˆè§£æï¼‰ã—ã¾ã™ï¼",
        "ã‚µãƒ¼ãƒãƒ¼ãŒçŸ¥æµç†±ã‚’å‡ºã•ãªã„ç¨‹åº¦ã«å…¨åŠ›èµ°ä¸­ã§ã™ã€‚",
        "äººå·¥è¡›æ˜Ÿã‹ã‚‰åœ°è¡¨ã®ç†±æºã‚’å‡è¦–ã—ã¦ã„ã¾ã™ã€‚ã¾ã°ãŸãå³ç¦...",
        "åœ°çƒã®é¼“å‹•ã‚’ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ä¸­ã€‚å°‘ã€…ãŠå¾…ã¡ã‚’ã€‚",
        "1ã¨0ã®æµ·ã‹ã‚‰ã€ã‚ãªãŸã«æœ€é©ãªã‚¨ãƒãƒ«ã‚®ãƒ¼ã®çœŸç ã‚’ã™ãã„ä¸Šã’ã¦ã„ã¾ã™ã€‚",
        "ã‚³ãƒ¼ãƒ’ãƒ¼ã‚’ä¸€å£é£²ã‚€æ™‚é–“ã¯ã‚ã‚Šã¾ã™ã€‚ã§ã‚‚äºŒå£ç›®ã¯é–“ã«åˆã‚ãªã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚",
        "æœªæ¥ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’è¨ˆç®—ä¸­... å¾…ã£ã¦ã„ã‚‹é–“ã«ã€ã‚ãªãŸã®è„³å†…ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚‚å……é›»ã—ã¦ãŠã„ã¦ãã ã•ã„ã€‚",
        "ã“ã®é–“ã«ã€åœ°çƒã®è£å´ã§ã¯å¤ªé™½ãŒæ²ˆã¿ã€é¢¨ãŒå¹ãå§‹ã‚ã¦ã„ã¾ã™ã€‚"
    ];

    // --- çŠ¶æ…‹ç®¡ç† ---
    let currentSeason = 'spring';
    let currentTime = 12;
    let currentData = null;
    let compareList = [];
    let radarChart = null;
    let lineChart = null;
    let currentMarker = null; // ç¾åœ¨åœ°ç‚¹ãƒãƒ¼ã‚«ãƒ¼

    // --- åœ°å›³åˆæœŸåŒ– ---
    const map = L.map('map', {
        zoomControl: true,
        maxBounds: [[20, 120], [50, 155]], // æ—¥æœ¬ä»˜è¿‘ã«åˆ¶é™
        minZoom: 5
    }).setView([36.5, 138], 5);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; ã‚ªãƒ¼ãƒ—ãƒ³ã‚¹ãƒˆãƒªãƒ¼ãƒˆãƒãƒƒãƒ—å”åŠ›è€…'
    }).addTo(map);

    // --- ãƒ•ãƒƒã‚¿ãƒ¼åºƒå‘Šï¼ˆãƒ†ã‚­ã‚¹ãƒˆã®ã¿ï¼‰ ---
    function mountAdBar() {
        const adFooter = document.getElementById('ad-footer');
        const adClose = document.getElementById('ad-close');
        const adLink = document.getElementById('ad-link');

        // è¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆå›ºå®šï¼†ãƒªãƒ³ã‚¯å…ˆã‚’è¨­å®šï¼ˆå¿…è¦ã«å¿œã˜ã¦å¤‰æ›´ï¼‰
        adLink.textContent = "ã“ã®æ£®å³¶å„ªèª ã•ã‚“ã®ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã¯ã€6ã†ã‚åŸå„ªã®githubã§å…¬é–‹ä¸­ã§ã™ã€‚";
        adLink.href = "https://github.com/yh192168"; // â† å®Ÿéš›ã®å…¬é–‹URLã«ç½®ãæ›ãˆã¦ã­

        // æ—¢ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé–‰ã˜ãŸï¼Ÿ
        const closed = sessionStorage.getItem('bottom_ad_closed') === '1';
        if (closed) {
            adFooter.classList.add('hidden');
            document.body.classList.remove('has-ad');
            return;
        }

        // è¡¨ç¤º
        adFooter.classList.remove('hidden');
        document.body.classList.add('has-ad');

        // é–‰ã˜ã‚‹
        adClose.addEventListener('click', () => {
            adFooter.classList.add('hidden');
            document.body.classList.remove('has-ad');
            sessionStorage.setItem('bottom_ad_closed', '1');
        });
    }

    // --- é–¢æ•°ç¾¤ ---
    function showLoading() {
        const msg = LOADING_MESSAGES[Math.floor(Math.random() * LOADING_MESSAGES.length)];
        document.getElementById('loading-text').innerText = msg;
        document.getElementById('loading').style.display = 'flex';
    }

    function hideLoading() {
        document.getElementById('loading').style.display = 'none';
    }

    function switchTab(tab) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
        if (tab === 'analyze') {
            document.querySelector('.tab:nth-child(1)').classList.add('active');
            document.getElementById('analyze-section').classList.add('active');
        } else {
            document.querySelector('.tab:nth-child(2)').classList.add('active');
            document.getElementById('compare-section').classList.add('active');
        }
    }

    function setSeason(season) {
        currentSeason = season;
        document.querySelectorAll('.season-btn').forEach(btn => {
            const label = (season === 'spring' ? 'æ˜¥' : season === 'summer' ? 'å¤' : season === 'autumn' ? 'ç§‹' : 'å†¬');
            btn.classList.toggle('active', btn.innerText === label);
        });
        if (currentData) analyze(currentData.lat, currentData.lon, currentData.name);
    }

    function updateTime(val) {
        currentTime = parseInt(val, 10);
        document.getElementById('time-display').innerText = `${String(val).padStart(2, '0')}:00`;
        if (currentData) analyze(currentData.lat, currentData.lon, currentData.name);
    }

    function analyze(lat, lon, customName = null) {
        showLoading();

        // ã‚¯ãƒªãƒƒã‚¯åœ°ç‚¹ãƒãƒ¼ã‚«ãƒ¼ã®æ›´æ–°
        if (currentMarker) map.removeLayer(currentMarker);
        currentMarker = L.marker([lat, lon]).addTo(map);

        const emailParam = 'your_email@example.com'; // â† è‡ªåˆ†ã®é€£çµ¡å…ˆã«ç½®ãæ›ãˆã¦ã­
        const reverseUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=12&accept-language=ja&email=${encodeURIComponent(emailParam)}`;

        fetch(reverseUrl)
            .then(r => r.json())
            .then(data => {
                const addr = data.address || {};
                const city = addr.city || addr.town || addr.village || addr.suburb || "åœ°åŸŸä¸æ˜";
                const pref = addr.province || addr.state || "";
                const fullName = customName || (pref ? `${pref} ${city}` : city);

                // ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«è¨ˆç®—ï¼ˆç°¡æ˜“ãƒ«ãƒ¼ãƒ«ï¼‰
                let p = { solar: 30, wind: 15, geo: 5, hydro: 15, bio: 15 };
                if (pref.includes("å¤§åˆ†") || pref.includes("ç†Šæœ¬")) p.geo = 85;
                else if (pref.includes("åŒ—æµ·é“") || pref.includes("é’æ£®")) p.wind = 80;
                else if (city.includes("åŒº")) p.solar = 70;
                else if (pref.includes("é•·é‡") || pref.includes("å²é˜œ")) p.hydro = 60;

                // å­£ç¯€ãƒ»æ™‚é–“è£œæ­£
                const sf = SEASON_FACTORS[currentSeason];
                const hourFactor = (currentTime >= 6 && currentTime <= 18)
                    ? Math.sin((currentTime - 6) / 12 * Math.PI)
                    : 0;

                let currentOutput = {
                    solar: p.solar * sf.solar * hourFactor,
                    wind: p.wind * sf.wind * (0.8 + Math.random() * 0.4),
                    geo: p.geo * sf.geo,
                    hydro: p.hydro * sf.hydro,
                    bio: p.bio * sf.bio
                };

                // æœ€é©ç¨®åˆ¥åˆ¤å®š
                let bestType = "SOLAR_AGRI";
                if (p.geo > 70) bestType = "GEO_FLASH";
                else if (p.wind > 60) bestType = (city.includes("æµ·") || city.includes("æ¸¯")) ? "WIND_OFFSHORE" : "WIND_ONSHORE";
                else if (p.solar > 60) bestType = city.includes("åŒº") ? "SOLAR_ROOF" : "SOLAR_AGRI";
                else if (p.hydro > 50) bestType = "HYDRO_SMALL";
                else if (p.bio > 30) bestType = "BIO_WOOD";

                const res = MASTER[bestType];
                currentData = {
                    lat, lon, name: fullName,
                    season: currentSeason,
                    time: currentTime,
                    p, res, bestType
                };

                updateUI(fullName, res, currentOutput, p);
                hideLoading();
            })
            .catch(() => {
                hideLoading();
                alert("è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
            });
    }

    function updateUI(name, res, output, p) {
        document.getElementById('result-placeholder').style.display = 'none';
        document.getElementById('result-display').style.display = 'block';

        document.getElementById('res-badge').innerText = "æœ€é©ã‚¨ãƒãƒ«ã‚®ãƒ¼";
        document.getElementById('res-badge').style.background = res.c;
        document.getElementById('res-title').innerText = res.n;
        document.getElementById('res-location').innerText = `ğŸ“ ${name} (${currentData.lat.toFixed(4)}, ${currentData.lon.toFixed(4)})`;
        document.getElementById('res-description').innerHTML =
            `<strong>è§£æè§£èª¬:</strong><br>${res.t}<br><br>` +
            `ç¾åœ¨ã®${currentSeason === 'spring' ? 'æ˜¥' : currentSeason === 'summer' ? 'å¤' : currentSeason === 'autumn' ? 'ç§‹' : 'å†¬'}ãƒ»${currentTime}æ™‚ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€` +
            `ã“ã®åœ°ç‚¹ã®ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ã‚’æœ€å¤§é™ã«å¼•ãå‡ºã™ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚`;

        updateCharts(p);

        document.getElementById('add-compare-btn').onclick = () => addToCompare(currentData);
    }

    function updateCharts(p) {
        const labels = ['å¤ªé™½å…‰', 'é¢¨åŠ›', 'åœ°ç†±', 'æ°´åŠ›', 'ãƒã‚¤ã‚ªãƒã‚¹'];
        const data = [p.solar, p.wind, p.geo, p.hydro, p.bio];

        // ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ
        if (radarChart) radarChart.destroy();
        radarChart = new Chart(document.getElementById('radarChart'), {
            type: 'radar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'åŸºæœ¬ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«',
                    data: data,
                    backgroundColor: 'rgba(243, 156, 18, 0.2)',
                    borderColor: 'rgba(243, 156, 18, 1)',
                    borderWidth: 2
                }]
            },
            options: {
                scales: { r: { min: 0, max: 100 } },
                maintainAspectRatio: false
            }
        });

        // ãƒ©ã‚¤ãƒ³ãƒãƒ£ãƒ¼ãƒˆ (24æ™‚é–“äºˆæ¸¬)
        const hours = Array.from({length: 24}, (_, i) => `${i}æ™‚`);
        const sf = SEASON_FACTORS[currentSeason];
        const solarLine = hours.map((_, h) => {
            const hf = (h >= 6 && h <= 18) ? Math.sin((h - 6) / 12 * Math.PI) : 0;
            return p.solar * sf.solar * hf;
        });
        const windLine = hours.map(() => p.wind * sf.wind * 0.9);
        const baseLine = hours.map(() => (p.geo + p.hydro + p.bio) / 3);

        if (lineChart) lineChart.destroy();
        lineChart = new Chart(document.getElementById('lineChart'), {
            type: 'line',
            data: {
                labels: hours,
                datasets: [
                    { label: 'å¤ªé™½å…‰', data: solarLine, borderColor: '#f1c40f', fill: false, tension: 0.4 },
                    { label: 'é¢¨åŠ›',   data: windLine,  borderColor: '#3498db', fill: false, tension: 0.4 },
                    { label: 'ãƒ™ãƒ¼ã‚¹ãƒ­ãƒ¼ãƒ‰', data: baseLine, borderColor: '#27ae60', fill: false, tension: 0.1 }
                ]
            },
            options: {
                maintainAspectRatio: false,
                scales: { y: { min: 0 } }
            }
        });
    }

    function addToCompare(data) {
        if (compareList.length >= 5) {
            alert("æ¯”è¼ƒãƒªã‚¹ãƒˆã¯æœ€å¤§5ç®‡æ‰€ã¾ã§ã§ã™ã€‚");
            return;
        }
        if (compareList.find(item => item.name === data.name)) {
            alert("æ—¢ã«ãƒªã‚¹ãƒˆã«è¿½åŠ ã•ã‚Œã¦ã„ã¾ã™ã€‚");
            return;
        }
        compareList.push(JSON.parse(JSON.stringify(data)));
        updateCompareUI();
        showToast(`${data.name}ã‚’æ¯”è¼ƒãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸ`);
    }

    function updateCompareUI() {
        document.getElementById('compare-count').innerText = compareList.length;
        const listEl = document.getElementById('compare-list');
        listEl.innerHTML = '';
        compareList.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'compare-item';
            div.innerHTML = `
                <span>${item.name} <span style="color:#888; font-size:0.85em;">(${item.season}/${String(item.time).padStart(2,'0')}æ™‚)</span></span>
                <span class="remove-btn" title="å‰Šé™¤" onclick="removeFromCompare(${index})">&times;</span>
            `;
            listEl.appendChild(div);
        });
    }

    function removeFromCompare(index) {
        compareList.splice(index, 1);
        updateCompareUI();
    }

    function executeComparison() {
        if (compareList.length < 2) {
            alert("æ¯”è¼ƒã«ã¯å°‘ãªãã¨ã‚‚2ç®‡æ‰€ã®åœ°ç‚¹ãŒå¿…è¦ã§ã™ã€‚");
            return;
        }

        let html = `<table class="compare-table">
            <tr>
                <th>é …ç›®</th>
                ${compareList.map(item => `<th>${item.name}</th>`).join('')}
            </tr>
            <tr>
                <td>ä¸»è¦ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«</td>
                ${compareList.map(item => `<td>${item.res.n}</td>`).join('')}
            </tr>
            <tr>
                <td>ä¾›çµ¦å®‰å®šæ€§</td>
                ${compareList.map(item => `<td class="${getBestClass(item, 'stable')}">${item.res.stable} / 5</td>`).join('')}
            </tr>
            <tr>
                <td>ã‚³ã‚¹ãƒˆåŠ¹ç‡</td>
                ${compareList.map(item => `<td class="${getBestClass(item, 'cost')}">${item.res.cost} / 5</td>`).join('')}
            </tr>
            <tr>
                <td>ç’°å¢ƒè² è·ä½æ¸›</td>
                ${compareList.map(item => `<td class="${getBestClass(item, 'env')}">${item.res.env} / 5</td>`).join('')}
            </tr>
            <tr>
                <td>å°†æ¥æ€§</td>
                ${compareList.map(item => `<td class="${getBestClass(item, 'future')}">${item.res.future} / 5</td>`).join('')}
            </tr>
            <tr style="font-weight:bold; background:#eee;">
                <td>ç·åˆã‚¹ã‚³ã‚¢</td>
                ${compareList.map(item => {
                    const score = item.res.stable + item.res.cost + item.res.env + item.res.future;
                    return `<td>${score}</td>`;
                }).join('')}
            </tr>
        </table>`;

        document.getElementById('compare-result-table').innerHTML = html;

        const bestItem = [...compareList].sort((a, b) =>
            (b.res.stable + b.res.cost + b.res.env + b.res.future) -
            (a.res.stable + a.res.cost + a.res.env + a.res.future)
        )[0];

        document.getElementById('compare-summary').innerHTML = `
            <strong>ç·åˆåˆ¤å®šçµæœ:</strong><br>
            ä»Šå›ã®æ¯”è¼ƒã«ãŠã„ã¦ã€æœ€ã‚‚ãƒãƒ©ãƒ³ã‚¹ãŒè‰¯ãæ¨å¥¨ã•ã‚Œã‚‹åœ°åŸŸã¯ã€Œ<strong>${bestItem.name}</strong>ã€ã§ã™ã€‚<br>
            ç‰¹ã«${bestItem.res.n}ã‚’æ ¸ã¨ã—ãŸã‚¨ãƒãƒ«ã‚®ãƒ¼æ§‹æˆã¯ã€åœ°åŸŸã®ãƒ¬ã‚¸ãƒªã‚¨ãƒ³ã‚¹å‘ä¸Šã«å¤§ããå¯„ä¸ã—ã¾ã™ã€‚
        `;

        document.getElementById('compare-modal').style.display = 'flex';
        document.body.classList.add('modal-open');
    }

    function getBestClass(item, prop) {
        const maxVal = Math.max(...compareList.map(i => i.res[prop]));
        return item.res[prop] === maxVal ? 'best-highlight' : '';
    }

    function closeModal() {
        document.getElementById('compare-modal').style.display = 'none';
        document.body.classList.remove('modal-open');
    }

    function showToast(msg) {
        const toast = document.createElement('div');
        toast.style.position = 'fixed';
        toast.style.bottom = '20px';
        toast.style.left = '50%';
        toast.style.transform = 'translateX(-50%)';
        toast.style.background = 'rgba(0,0,0,0.7)';
        toast.style.color = 'white';
        toast.style.padding = '10px 20px';
        toast.style.borderRadius = '20px';
        toast.style.zIndex = '5000';
        toast.innerText = msg;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    // --- ã‚¤ãƒ™ãƒ³ãƒˆ ---
    map.on('click', e => analyze(e.latlng.lat, e.latlng.lng));

    const searchBtn = document.getElementById('search-btn');
    const searchInput = document.getElementById('search-input');

    searchBtn.onclick = () => {
        const query = searchInput.value.trim();
        if (!query) return;

        const emailParam = 'your_email@example.com'; // â† è‡ªåˆ†ã®é€£çµ¡å…ˆã«ç½®ãæ›ãˆã¦ã­
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=jp&accept-language=ja&email=${encodeURIComponent(emailParam)}`;

        fetch(url)
            .then(r => r.json())
            .then(d => {
                if (Array.isArray(d) && d.length > 0) {
                    const lt = parseFloat(d[0].lat), ln = parseFloat(d[0].lon);
                    map.setView([lt, ln], 12);
                    analyze(lt, ln, query);
                } else {
                    alert("è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
                }
            })
            .catch(() => alert("æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚"));
    };

    // Enterã‚­ãƒ¼ã§æ¤œç´¢å®Ÿè¡Œ
    searchInput.addEventListener('keydown', (ev) => {
        if (ev.key === 'Enter') searchBtn.click();
    });

    // åˆæœŸåŒ–
    window.onload = () => {
        showToast("åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è§£æã‚’é–‹å§‹ã—ã¦ãã ã•ã„");
        mountAdBar(); // ãƒ•ãƒƒã‚¿ãƒ¼åºƒå‘Šï¼ˆãƒ†ã‚­ã‚¹ãƒˆï¼‰è¡¨ç¤º
    };
</script>

</body>
</html>